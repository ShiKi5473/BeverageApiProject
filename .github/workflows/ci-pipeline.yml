name: Java CI with Maven & Qodana

on:
  push:
    branches: [ "develop", "main", "feature/*" ]
  pull_request:
    branches: [ "develop", "main" ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Qodana 分析需要完整的 git history

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      - name: Build and Test with Maven
        # 這裡執行 mvn verify 會自動觸發我們剛寫好的 TestContainers 測試
        env:
          # 1. 強制限制 JVM Heap 為 1.5GB (避免 Java 吃光所有 RAM)
          # 2. 停用 Ryuk (Testcontainers 的資源回收車)，CI 跑完會自動銷毀環境，不需要它佔用資源
          MAVEN_OPTS: "-Xmx1536m -Xms512m -XX:+TieredCompilation -XX:TieredStopAtLevel=1"
          TESTCONTAINERS_RYUK_DISABLED: "true"
        run: mvn verify

      - name: Check for OOM Killer logs
        if: failure() # 只有在前一個步驟失敗時才執行
        run: |
          sudo dmesg | grep -i 'killed process' || true
          docker ps -a

      - name: Qodana Scan
        uses: JetBrains/qodana-action@v2023.3
        with:
          # 【關鍵修改】指定使用社群版 (Community)，不需要 QODANA_TOKEN
          args: --linter,jetbrains/qodana-jvm-community
          upload-result: false
          use-annotations: true
          pr-mode: true
        continue-on-error: true # 暫時允許掃描失敗不中斷流程，初期調整用

      - name: Build Docker Image (Dry Run)
        # 驗證 Dockerfile 是否能成功建置 Image
        run: docker build . --file Dockerfile --tag beverage-api:latest

